# Servidor HTTP principal para o WordPress
server {
    listen 80;                         # Porta padrão HTTP
    server_name _;                     # Aceita qualquer host (o Tunnel já faz o roteamento)

    root /var/www/html;                # Pasta raiz do WordPress (montada no Docker)
    index index.php index.html;        # Ordem dos arquivos index

    # =========================
    # GZIP (compressão de resposta)
    # =========================
    gzip on;                           # Ativa compressão gzip
    gzip_types text/plain text/css application/json application/javascript application/xml application/rss+xml text/javascript;
                                       # Tipos de conteúdo que serão comprimidos
    gzip_min_length 1024;              # Só comprime respostas maiores que 1KB
    gzip_comp_level 5;                 # Nível de compressão (1=rápido, 9=lento; 5 é um meio-termo bom)

    # =========================
    # Cabeçalhos de Segurança
    # =========================
    add_header X-Frame-Options "SAMEORIGIN" always;             # Impede que seu site seja aberto em iframe de outros domínios
    add_header X-Content-Type-Options "nosniff" always;         # Navegador não tenta adivinhar tipo de arquivo
    add_header X-XSS-Protection "1; mode=block" always;         # Ajuda contra alguns tipos de XSS em navegadores antigos
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;  # Limita o cabeçalho Referer enviado para outros sites

    # =========================
    # CACHE DE PÁGINA INTEIRA (Nginx)
    # =========================
    # Diretório de cache no sistema de arquivos do container (rápido o suficiente pra homelab)
    proxy_cache_path /var/cache/nginx/wordpress levels=1:2 keys_zone=WP_CACHE:10m inactive=60m max_size=1g;
    # /var/cache/nginx/wordpress = onde o cache é salvo
    # levels=1:2               = estrutura de subpastas pra não entupir um diretório só
    # keys_zone=WP_CACHE:10m   = zona de cache chamada "WP_CACHE" com índice de 10MB
    # inactive=60m             = se uma chave não for usada em 60 minutos, é descartada
    # max_size=1g              = limite máximo de espaço em disco pro cache

    # =========================
    # BLOCO PRINCIPAL (com cache de página)
    # =========================
    location / {
        # Padrão WordPress: tenta arquivo físico, depois pasta, depois index.php
        try_files $uri $uri/ /index.php?$args;

        # Somente aplica cache para requisições GET/HEAD (não POST, etc.)
        limit_except GET HEAD {
            proxy_cache off;           # Não cacheia POST, PUT, DELETE etc. (importante pra formulários/login)
        }

        # Usa a zona de cache declarada acima
        proxy_cache WP_CACHE;          # Zona de cache usada aqui
        proxy_cache_valid 200 302 10s; # Respostas 200/302 ficam em cache por 10 segundos (pode aumentar depois)
        proxy_cache_valid 404 1m;      # 404 em cache por 1 minuto
        add_header X-Cache $upstream_cache_status;   # Header pra ver HIT/BYPASS/MISS no navegador (debug)
    }

    # =========================
    # Arquivos Estáticos (imagens, CSS, JS, fontes)
    # =========================
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2)$ {
        expires 30d;                   # Cache de 30 dias no navegador
        access_log off;                # Não registrar logs desses acessos
    }

    # =========================
    # Proteção do wp-config
    # =========================
    location = /wp-config.php {
        deny all;                      # Bloqueia acesso direto ao wp-config.php
    }

    # =========================
    # Processamento PHP (WordPress via PHP-FPM)
    # =========================
    location ~ \.php$ {
        try_files $uri =404;                           # Se o arquivo PHP não existe, retorna 404
        fastcgi_index index.php;                       # Arquivo index padrão
        fastcgi_pass wordpress:9000;                   # Envia a requisição pro PHP-FPM (container "wordpress" porta 9000)
        include fastcgi_params;                        # Parâmetros padrão FastCGI
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
                                                       # Caminho completo do script PHP no sistema de arquivos
        # Aqui não ativamos cache no fastcgi; o cache de página está no bloco 'location /'.
    }

    # =========================
    # Bloquear arquivos ocultos (.git, .env se vazarem, etc.)
    # =========================
    location ~ /\. {
        deny all;                      # Bloqueia qualquer arquivo/pasta que começa com ponto
    }
}
